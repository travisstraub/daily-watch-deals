<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Watch Deals</title>
  <meta name="description" content="Daily watch deals with the biggest price drops." />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; max-width: 860px; }
    header { margin-bottom: 18px; }
    h1 { margin: 0 0 6px; font-size: 28px; }
    .sub { color: #555; margin: 0 0 10px; }
    .pill { display: inline-block; padding: 3px 10px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; color:#333; }
    .card { border: 1px solid #e6e6e6; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .row { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; }
    .title { font-weight: 650; text-decoration: none; color: #111; }
    .meta { color: #555; font-size: 14px; margin-top: 6px; line-height: 1.35; }
    .drop { font-weight: 750; }
    .btn { display:inline-block; margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid #ddd; text-decoration:none; color:#111; }
    footer { margin-top: 22px; font-size: 13px; color: #666; line-height: 1.4; }
  </style>
</head>
<body>
  <header>
    <h1>Daily Watch Deals</h1>
    <p class="sub">Biggest price drops I found today (Keepa / CamelCamelCamel research).</p>
    <span class="pill" id="asof">Loading…</span>
  </header>

  <main id="list"></main>

  <footer>
    <p><strong>Disclosure:</strong> As an Amazon Associate I earn from qualifying purchases.</p>
    <p>Prices can change at any time. Verify the current price on Amazon before buying.</p>
  </footer>

  <script>
    const ASSOC_TAG = "straubmediagr-20";
    const AMAZON_BASE = "https://www.amazon.com/dp/";

    function money(x) {
      if (x == null) return "";
      return "$" + Number(x).toFixed(2).replace(/\.00$/, "");
    }

    function buildUrl(deal) {
      // If you ever want to override with a custom URL, you can still include deal.url in deals.json
      if (deal.url && deal.url.startsWith("http")) return deal.url;

      const asin = (deal.asin || "").trim();
      if (!asin) return "#";

      const params = new URLSearchParams({
        tag: ASSOC_TAG
      });

      return `${AMAZON_BASE}${encodeURIComponent(asin)}?${params.toString()}`;
    }

    async function run() {
      const res = await fetch("./deals.json", { cache: "no-store" });
      const data = await res.json();

      document.getElementById("asof").textContent = `Updated: ${data.updated}`;

      const deals = [...(data.deals || [])].sort((a, b) => (b.dropPercent ?? 0) - (a.dropPercent ?? 0));
      const list = document.getElementById("list");
      list.innerHTML = "";

      for (const d of deals) {
        const url = buildUrl(d);

        const nowText = d.now != null ? `Now ${money(d.now)}` : "";
        const wasText = d.was != null ? `Was ${money(d.was)}` : "";
        const dropText = d.dropPercent != null ? `${d.dropPercent}% off` : "";

        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="row">
            <a class="title" href="${url}" target="_blank" rel="nofollow sponsored noopener">${d.title}</a>
            <div class="drop">${dropText}</div>
          </div>
          <div class="meta">
            ${nowText}${(nowText && wasText) ? " • " : ""}${wasText}
            ${(d.notes && (nowText || wasText)) ? " • " : ""}${d.notes || ""}
          </div>
          <a class="btn" href="${url}" target="_blank" rel="nofollow sponsored noopener">View deal</a>
        `;
        list.appendChild(el);
      }
    }

    run().catch(() => {
      document.getElementById("list").textContent = "Could not load deals.json";
    });
  </script>
</body>
</html>
